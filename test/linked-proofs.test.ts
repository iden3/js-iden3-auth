import { AuthorizationRequestMessage, CircuitId, ProofType } from '@0xpolygonid/js-sdk';
import { Verifier } from '@lib/auth/auth';
import { resolvers, schemaLoader, testOpts } from './mocks';
import path from 'path';
import { PROTOCOL_CONSTANTS } from '@0xpolygonid/js-sdk';

describe('Linked proofs verification', () => {
  it('should verification pass', async () => {
    const authRequest: AuthorizationRequestMessage = {
      id: 'f5bcdfc9-3819-4052-ad97-c059119e563c',
      typ: PROTOCOL_CONSTANTS.MediaType.PlainMessage,
      type: 'https://iden3-communication.io/authorization/1.0/request',
      thid: 'f5bcdfc9-3819-4052-ad97-c059119e563c',
      body: {
        callbackUrl: 'http://localhost:8080/callback?id=1234442-123123-123123',
        reason: 'reason',
        message: 'mesage',
        did_doc: {},
        scope: [
          {
            id: 1,
            circuitId: CircuitId.AtomicQueryV3,
            optional: false,
            query: {
              proofType: ProofType.BJJSignature,
              allowedIssuers: ['*'],
              type: 'KYCAgeCredential',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-nonmerklized.jsonld',
              credentialSubject: {
                documentType: {
                  $eq: 99
                }
              }
            }
          },
          {
            id: 2,
            circuitId: CircuitId.LinkedMultiQuery10,
            optional: false,
            query: {
              groupId: 1,
              proofType: ProofType.Iden3SparseMerkleTreeProof,
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                documentType: {
                  $eq: 1
                },
                position: {
                  $eq: 'boss',
                  $ne: 'employee'
                }
              }
            }
          },
          {
            id: 3,
            circuitId: CircuitId.AtomicQueryV3,
            optional: false,
            query: {
              groupId: 1,
              proofType: ProofType.BJJSignature,
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                hireDate: {
                  $eq: '2023-12-11'
                }
              }
            }
          }
        ]
      },
      from: 'did:polygonid:polygon:mumbai:2qHwoMVgF22ozYfs4gXiC8rr6S3sBCr2WSQwkRTfB3'
    };

    const tokenString =
      'eyJhbGciOiJncm90aDE2IiwiY2lyY3VpdElkIjoiYXV0aFYyIiwiY3JpdCI6WyJjaXJjdWl0SWQiXSwidHlwIjoiYXBwbGljYXRpb24vaWRlbjMtemtwLWpzb24ifQ.eyJpZCI6IjgxN2JiMGQ4LTVkYzUtNGI1NS1iMzk2LWNmZjBkZGQzNGNlNSIsInR5cCI6ImFwcGxpY2F0aW9uL2lkZW4zLXprcC1qc29uIiwidHlwZSI6Imh0dHBzOi8vaWRlbjMtY29tbXVuaWNhdGlvbi5pby9hdXRob3JpemF0aW9uLzEuMC9yZXNwb25zZSIsInRoaWQiOiI3ZTViNTg0Ny1iNDc5LTQ0OTktOTBlZS01ZmU0ODI2YTViZGQiLCJib2R5Ijp7Im1lc3NhZ2UiOiJtZXNhZ2UiLCJzY29wZSI6W3siaWQiOjEsImNpcmN1aXRJZCI6ImNyZWRlbnRpYWxBdG9taWNRdWVyeVYzLWJldGEuMSIsInByb29mIjp7InBpX2EiOlsiMTk2NzM0NDA0MjA3MzU1Mjk0MDMzMzcwMjg2MzM1MTc3MzYxOTMzODA2MTQzMzE1MDEzMDU2MDg5OTI4MDU5MjI2NzU4MTQ0NTIxNzgiLCI0Nzg5MjQwMjg5OTk2NTg1NjAwNTUxNTYxMzcwODAzMzM3NDA0MTA3NDA5MzcwOTQzMzEwMzgzNzU2MzQ2NTM3MjY5MjA3NjAxODU3IiwiMSJdLCJwaV9iIjpbWyI1NjQ1MzMxNTc1MDQ1MjA1NjA5MDMzMjI3ODgyNDQ4MDI4NzkxNzQ5NDY4NjUwMTYxMjAxMDc1NTQzMTY5OTUzOTQxNTM3OTY0MzY2IiwiMTA4NTQ2OTE2NDA4MzYzMDQxNTQ4NTIzMzUyMDQwNDI0MDM4MDMxNzEyODcwNjE2NDQ2OTMzNzcwMjIwNzkyMDM0OTU3NzE5MTA1NjUiXSxbIjc2MjQ5ODc3NzM2NDE4NDI3ODEwMzMzMjcyMzEwNTYwMDYzNDQ0Nzg5MTY3NDYyNDA0NjI5NTc2MTY2OTY4ODE1ODYzNzM1NjY2MjkiLCI3Mzk3Mjk2NzU1MzkzOTI2MTg0NDU3NjgxMDE3OTk0NzQ4Mzk3MDU2NTE0OTA4NDU3Njk4ODg3NDQ5MzAyNTMwMzc0ODA5NTYxNjAxIl0sWyIxIiwiMCJdXSwicGlfYyI6WyI4NDEyODU2MTczNTI3MjM4OTczMzEwMjkyMjA4MDM0MzY2Njg2Nzc1MTU4Mzc3NzM3MDEwOTc2OTk5NTkzMDM1MjgwNzg3OTU0NjkyIiwiMjE4MTg0Mjg5MDYwOTg2NzY2NDMxMDk2MjI0NTEzNzEyMDczMzA0NTIyNzE5MDIzMDg3OTE4MDA3MDI2NTQ1NDA4NjMwNTc0MjIwNTIiLCIxIl0sInByb3RvY29sIjoiZ3JvdGgxNiIsImN1cnZlIjoiYm4xMjgifSwicHViX3NpZ25hbHMiOlsiMCIsIjIxNTc1MTI3MjE2MjM2MjQ4ODY5NzAyMjc2MjQ2MDM3NTU3MTE5MDA3NDY2MTgwMzAxOTU3NzYyMTk2NTkzNzg2NzMzMDA3MzYyIiwiNDQ4NzM4NjMzMjQ3OTQ4OTE1ODAwMzU5Nzg0NDk5MDQ4Nzk4NDkyNTQ3MTgxMzkwNzQ2MjQ4MzkwNzA1NDQyNTc1OTU2NDE3NTM0MSIsIjAiLCIwIiwiMCIsIjEiLCIxIiwiMjUxOTg1NDMzODEyMDA2NjU3NzA4MDU4MTYwNDYyNzE1OTQ4ODU2MDQwMDI0NDUxMDU3Njc2NTM2MTY4NzgxNjc4MjY4OTUzNjIiLCIxIiwiNDQ4NzM4NjMzMjQ3OTQ4OTE1ODAwMzU5Nzg0NDk5MDQ4Nzk4NDkyNTQ3MTgxMzkwNzQ2MjQ4MzkwNzA1NDQyNTc1OTU2NDE3NTM0MSIsIjE3MTA5NTEyOTYiLCIxOTgyODU3MjY1MTA2ODgyMDAzMzUyMDcyNzM4MzYxMjMzMzg2OTkiLCIwIiwiMyIsIjEiLCI5OSIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjEiLCIyNTE5ODU0MzM4MTIwMDY2NTc3MDgwNTgxNjA0NjI3MTU5NDg4NTYwNDAwMjQ0NTEwNTc2NzY1MzYxNjg3ODE2NzgyNjg5NTM2MiIsIjAiXX0seyJpZCI6MiwiY2lyY3VpdElkIjoibGlua2VkTXVsdGlRdWVyeTEwLWJldGEuMSIsInByb29mIjp7InBpX2EiOlsiMjEyMzY4MjczOTU2MTA5MjI5NTIxOTE0MDY3Nzc0ODIwOTE2MzA4NzAxNDIyMTQzNDk3NzAyNTYwMzc3NDM4MDkxMTk4NTcxNzA0OTUiLCIxNjE2NjczOTE5NjExMzAwNzc3ODg2Njc4MDc1MzU1MjQzMTk2MDY0NDcyMDQ5Njg5NTIzNTk1ODUzNDU2MTY3MTEyNDA0NDE1MTA3OCIsIjEiXSwicGlfYiI6W1siMzg5MDI3ODE1Mzk4NjUzMzI5NDEzMjMyMjU0NjAyMjE1ODgzNTM2Mjc0NjIxNzYwMTgwNjc1NzAyMTIwMDEwOTAzMDg2OTY2NTg3MCIsIjIxODc5NTczNzI0ODQ4MzgyOTExMDMxNTMzMTQ5ODAwODU2MjAxODcyOTY2ODE4MjQxMDM3NjI3NDgwODk1NDI3NDkxNjQ1Mjc3MjAyIl0sWyI1Njg3MTYyODY2OTg4MjU4NzMwMDk2NDk4MDAxMjA4MjQ0NjI0MDExNjE3MjI1OTk5Nzc0NTgxMTIxNDA2ODU4ODcxMzA5MTM3ODU2IiwiMTc3MjIzNjE1NzI1OTExNDg1NTk1NjIzODU2Nzg2MzI3ODY3MjM5MTk0Mjk5NTYyNzQzNTU0OTMzMzg5MzI2NjIxMTgzNTc1NDUxNDEiXSxbIjEiLCIwIl1dLCJwaV9jIjpbIjgxMzU5NDg0MTAxODAyNzQzODYzNjcwNTE2NzMzMjQ2MjU5NDk0OTQ0NDc3ODU4NTU0NjcyNjYxNTQ5ODIwMDc5MjUwOTE3MjU1NDQiLCIxNzU1MzA5MDIxNTExNjkwNzIxODEzNTg1MDY2NzUzMzQ0MjEyMzIxNTY5MDYyMjI5NjQ2OTI0MTE1NTUwODIxNjQwMDgyMzY5MTQ3NCIsIjEiXSwicHJvdG9jb2wiOiJncm90aDE2IiwiY3VydmUiOiJibjEyOCJ9LCJwdWJfc2lnbmFscyI6WyIxMjg1MzcwMDg0MjYzMjU3ODA2MDg4OTU3OTUxNTA2MjA4NzY5MjA3NjYxMTkzMjU2NjQ3MDk2NDU0MDI1MzQ1MzA4Mjk2MjM3NzQ3MiIsIjEiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMTU1NzcxMTQ3OTkwNTY5Mzk2MzM1NTI4NDU1MzEwMTEwMjQ2NzI5Mzk0OTM0OTI3Njk2MjgyODU2NjEzNTk3MTE2NTUyMTQ1NjExNjIiLCIxNjk5ODc2Mjk2NTM5Njk0NDc4MjY2NzU1Nzc0MTE4NTgyODEzNjQ2Nzc0Nzc2MjgzMDAyODIxNzAyNzk3MzYxNzM3Mzg2MjMwMTk1OCIsIjkzMDI1MjYyMDg1MDc3NTM3OTk1MDExMzAxMjg5MDg0OTQ2NzM0MTI0NDM2MzE1NDE0MjQ0MDk1NTEyMDUyNzc1Mjk5NDk2NjIzOTQiLCIxNDYxMjUxODAwNjQ5Mzk5ODAzNzE0OTI5OTY0Nzk3NDIzNzc3MTU1MTA3MDMxMjA5Njg4MjQwNzQ0MDY1MTA1Mjc1MjI1OTAzODQwMyIsIjE0NjEyNTE4MDA2NDkzOTk4MDM3MTQ5Mjk5NjQ3OTc0MjM3NzcxNTUxMDcwMzEyMDk2ODgyNDA3NDQwNjUxMDUyNzUyMjU5MDM4NDAzIiwiMTQ2MTI1MTgwMDY0OTM5OTgwMzcxNDkyOTk2NDc5NzQyMzc3NzE1NTEwNzAzMTIwOTY4ODI0MDc0NDA2NTEwNTI3NTIyNTkwMzg0MDMiLCIxNDYxMjUxODAwNjQ5Mzk5ODAzNzE0OTI5OTY0Nzk3NDIzNzc3MTU1MTA3MDMxMjA5Njg4MjQwNzQ0MDY1MTA1Mjc1MjI1OTAzODQwMyIsIjE0NjEyNTE4MDA2NDkzOTk4MDM3MTQ5Mjk5NjQ3OTc0MjM3NzcxNTUxMDcwMzEyMDk2ODgyNDA3NDQwNjUxMDUyNzUyMjU5MDM4NDAzIiwiMTQ2MTI1MTgwMDY0OTM5OTgwMzcxNDkyOTk2NDc5NzQyMzc3NzE1NTEwNzAzMTIwOTY4ODI0MDc0NDA2NTEwNTI3NTIyNTkwMzg0MDMiLCIxNDYxMjUxODAwNjQ5Mzk5ODAzNzE0OTI5OTY0Nzk3NDIzNzc3MTU1MTA3MDMxMjA5Njg4MjQwNzQ0MDY1MTA1Mjc1MjI1OTAzODQwMyJdfSx7ImlkIjozLCJjaXJjdWl0SWQiOiJjcmVkZW50aWFsQXRvbWljUXVlcnlWMy1iZXRhLjEiLCJwcm9vZiI6eyJwaV9hIjpbIjEyMzAwNTc2OTk2OTA1Mjk4OTgxMjI5NTMwNjYzNTEwNjg0NDQ5MjEyMzcxNTYxMDAxMzQ0MzAzOTQ5MTA0NjQ0NzczMTgxNTA2MzQ1IiwiNDQwMDU2NzIxMTg5Mzc2MzU1MzQ4OTg3MjA2Mjc2NDUzNTEwMTcyMzA1MDA1Njk0NTUxNDQyMTkxMzkwOTE5NTY2OTg0MzU3OTM2NSIsIjEiXSwicGlfYiI6W1siMTk0Njg1NDM1MzQwMTE1ODg0NzQyNTE5OTAzNjU2NDAwMTE3MjI0NTQ0ODEwNjcyNDIwNDY2MTQ2MjczNjQ1OTMwOTAyMTE5OTM4MjYiLCIxNTg2MjU1OTIxNjI1NzUyOTU2NDM3MzUyNTk3MTgxNDM0NjIyNjQyNTE2MzAyNzQwMDU3NjYwMDI5NTY2ODAzMDc5MzI3NTg5ODI5OSJdLFsiMTE3Nzc0NzYzMzA1NjUxMzMwOTQ4MzMxMTE3Nzk5NzgzOTA3MDc2MDU2MzU5MzM1NDc2MDM4NDM0NjkwMjcyNDkzNzY0NTE2MTYyNjQiLCIxMjcxMTM0MDM3MTUwNjA4MDk4ODk3MTU5NzQ3Nzk5NTEyNDA5MjExOTA4OTgwNzY2MTA2NjcwNjc2NDEwNzc1MTc0NTgwMTk2NTM2MyJdLFsiMSIsIjAiXV0sInBpX2MiOlsiMTY3MzE0NTM3OTY4Nzk3MjEzMTE5OTY4MDg3OTkwNjY5MjU1MDI5Mjg0NDM5MTM1Mjg5NTE4OTM5NjE0ODI0NDgyMzgwODkxNzc2MDkiLCIxNTYyMTYyODU5OTkyMDg1NDk5MDM2MTIwMjI5NDM4NTA3ODM2NTE3MDAxOTA3OTY5MjUxODI2NDg2ODc4NjkyNjY1NzA3NzQ4MjUyNCIsIjEiXSwicHJvdG9jb2wiOiJncm90aDE2IiwiY3VydmUiOiJibjEyOCJ9LCJwdWJfc2lnbmFscyI6WyIxIiwiMjE1NzUxMjcyMTYyMzYyNDg4Njk3MDIyNzYyNDYwMzc1NTcxMTkwMDc0NjYxODAzMDE5NTc3NjIxOTY1OTM3ODY3MzMwMDczNjIiLCI0NDg3Mzg2MzMyNDc5NDg5MTU4MDAzNTk3ODQ0OTkwNDg3OTg0OTI1NDcxODEzOTA3NDYyNDgzOTA3MDU0NDI1NzU5NTY0MTc1MzQxIiwiMTI4NTM3MDA4NDI2MzI1NzgwNjA4ODk1Nzk1MTUwNjIwODc2OTIwNzY2MTE5MzI1NjY0NzA5NjQ1NDAyNTM0NTMwODI5NjIzNzc0NzIiLCIwIiwiMCIsIjEiLCIzIiwiMjUxOTg1NDMzODEyMDA2NjU3NzA4MDU4MTYwNDYyNzE1OTQ4ODU2MDQwMDI0NDUxMDU3Njc2NTM2MTY4NzgxNjc4MjY4OTUzNjIiLCIxIiwiNDQ4NzM4NjMzMjQ3OTQ4OTE1ODAwMzU5Nzg0NDk5MDQ4Nzk4NDkyNTQ3MTgxMzkwNzQ2MjQ4MzkwNzA1NDQyNTc1OTU2NDE3NTM0MSIsIjE3MTA5NTEzMTEiLCIyMTk1Nzg2MTcwNjQ1NDAwMTYyMzQxNjE2NDAzNzU3NTU4NjU0MTIiLCIxMjk2MzUxNzU4MjY5MDYxMTczMzE3MTA1MDQxOTY4MDY3MDc3NDUxOTE0Mzg2MDg2MjIyOTMxNTE2MTk5MTk0OTU5ODY5NDYzODgyIiwiMCIsIjEiLCIxNzAyMjUyODAwMDAwMDAwMDAwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMSIsIjI1MTk4NTQzMzgxMjAwNjY1NzcwODA1ODE2MDQ2MjcxNTk0ODg1NjA0MDAyNDQ1MTA1NzY3NjUzNjE2ODc4MTY3ODI2ODk1MzYyIiwiMCJdfV19LCJmcm9tIjoiZGlkOnBvbHlnb25pZDpwb2x5Z29uOm11bWJhaToycUQ1OEt2RDNtUEIxSDFkWktoRFBSaEVkM2FFMUZkeDNpR2Q1VmpjSHEiLCJ0byI6ImRpZDpwb2x5Z29uaWQ6cG9seWdvbjptdW1iYWk6MnFId29NVmdGMjJvellmczRnWGlDOHJyNlMzc0JDcjJXU1F3a1JUZkIzIn0.eyJwcm9vZiI6eyJwaV9hIjpbIjE1MDg0NDY2Mjg4MDYwMTgyMzcxNTY0MTY4NTUyODc2NDk0NjcxODY1Nzg0NDUyOTk2Mzg1MzEzMDE0MjcwMjg5MzgzOTI2NjEwMDI2IiwiNzg3MjQ1MjA3NTAzMjYzMDkyMDQ5NjY3ODQ3MzQ4NjU3NDA3MTIwMzMzODc4MjQ4MTYxODQ0ODcwMjU1MjUzMzM4MzAzMTc3NDE3OCIsIjEiXSwicGlfYiI6W1siOTM1Nzk5NzE2NDc4NTc5OTc2NTIwNTg2NTA0NjA2NzkwODU4OTI4ODA3MTI2Mjk0NDMwOTQxOTUwMzcwOTI5MjQzNzEwMDM4NzQzNyIsIjE5MjYyNDUzNjg4MTQzNDA5NzM0MTYwNTUxMzc1MjQxNjg0NjMyNDkzMTM0MDM0NTc1OTcwMDkzMjkzNjk4NDI0NTI4MzEzODc5NTA1Il0sWyIxOTY2NjI3MTI5MTE2MDgwNjExNTg0NjI4MjU5MjA4NTc2Nzg4NDA4MjI4MDc4ODM2Nzc0ODIyMzM2MDk4MDcyOTQ5MTM3ODY0MDc1OCIsIjYzMjc2NzA2NDExMjQ3NzY0NDkxNTI3MzM1MTc2Mjk2MzQ5MDM5MTY1NDUxOTc3ODM0NDY0MDcxMjU0Mjc4MTIyMDA1NTc3NzkyMTQiXSxbIjEiLCIwIl1dLCJwaV9jIjpbIjE4NjY5ODA4OTY1OTI3OTQ0ODA0NzQ4Nzk2ODkzNjI4NjcwNzU4NTQ4OTA5MDcwNjU4MjM3NjU0MTU5OTMzNDg0NTM0MDAzMDYxMzAyIiwiMjEzOTU2MTU0MDM1NjAwNTQwNDU3MDI1MDM4ODY4Mzk2NDkyMjUzNDAyNzM4MDUwMzEyMzA2NzY4MzUwOTkxMjEwNTU1Mjk3MjY3NjQiLCIxIl0sInByb3RvY29sIjoiZ3JvdGgxNiIsImN1cnZlIjoiYm4xMjgifSwicHViX3NpZ25hbHMiOlsiMjE1NzUxMjcyMTYyMzYyNDg4Njk3MDIyNzYyNDYwMzc1NTcxMTkwMDc0NjYxODAzMDE5NTc3NjIxOTY1OTM3ODY3MzMwMDczNjIiLCIzNzgyOTkwOTU4NzI5ODMxNzA0NDYzMzc0NjQwNjYxODgwMjQ3OTAyNzk1NDUxMDU1MDE0NjM2Mjg5MTcxOTYyODk5MTA1MjgyODc0IiwiMCJdfQ';

    const verifier = await Verifier.newVerifier({
      stateResolver: resolvers,
      circuitsDir: path.join(__dirname, './testdata'),
      documentLoader: schemaLoader
    });

    await verifier.fullVerify(tokenString, authRequest, testOpts);
  });
});
