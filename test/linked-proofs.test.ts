import { AuthorizationRequestMessage, CircuitId } from '@0xpolygonid/js-sdk';
import { Verifier } from '@lib/auth/auth';
import { resolvers, schemaLoader } from './mocks';
import path from 'path';
import { PROTOCOL_CONSTANTS } from '@0xpolygonid/js-sdk';

describe('Linked proofs verification', () => {
  it('should verification pass', async () => {
    const authRequest: AuthorizationRequestMessage = {
      id: 'f5bcdfc9-3819-4052-ad97-c059119e563c',
      typ: PROTOCOL_CONSTANTS.MediaType.PlainMessage,
      type: 'https://iden3-communication.io/authorization/1.0/request',
      thid: 'f5bcdfc9-3819-4052-ad97-c059119e563c',
      body: {
        callbackUrl: 'http://localhost:8080/callback?id=1234442-123123-123123',
        reason: 'reason',
        message: 'mesage',
        did_doc: {},
        scope: [
          {
            id: 1,
            circuitId: CircuitId.AtomicQueryV3,
            optional: false,
            query: {
              proofType: 'BJJSignature2021',
              allowedIssuers: ['*'],
              type: 'KYCAgeCredential',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-nonmerklized.jsonld',
              credentialSubject: {
                documentType: {
                  $eq: 99
                }
              }
            }
          },
          {
            id: 2,
            circuitId: CircuitId.LinkedMultiQuery10,
            optional: false,
            query: {
              groupId: 1,
              proofType: 'Iden3SparseMerkleTreeProof',
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                documentType: {
                  $eq: 1
                },
                position: {
                  $eq: 'boss',
                  $ne: 'employee'
                }
              }
            }
          },
          {
            id: 3,
            circuitId: CircuitId.AtomicQueryV3,
            optional: false,
            query: {
              groupId: 1,
              proofType: 'BJJSignature2021',
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                hireDate: {
                  $eq: '2023-12-11'
                }
              }
            }
          }
        ]
      },
      from: 'did:iden3:polygon:mumbai:wzokvZ6kMoocKJuSbftdZxTD6qvayGpJb3m4FVXth'
    };

    const tokenString =
      'eyJhbGciOiJncm90aDE2IiwiY2lyY3VpdElkIjoiYXV0aFYyIiwiY3JpdCI6WyJjaXJjdWl0SWQiXSwidHlwIjoiYXBwbGljYXRpb24vaWRlbjMtemtwLWpzb24ifQ.eyJpZCI6IjUxMmRhMWVlLWQwODctNGEwMC1hMGYzLTZjNmZmYjI0Zjc5NyIsInR5cCI6ImFwcGxpY2F0aW9uL2lkZW4zLXprcC1qc29uIiwidHlwZSI6Imh0dHBzOi8vaWRlbjMtY29tbXVuaWNhdGlvbi5pby9hdXRob3JpemF0aW9uLzEuMC9yZXNwb25zZSIsInRoaWQiOiJmNWJjZGZjOS0zODE5LTQwNTItYWQ5Ny1jMDU5MTE5ZTU2M2MiLCJib2R5Ijp7Im1lc3NhZ2UiOiJtZXNhZ2UiLCJzY29wZSI6W3siaWQiOjEsImNpcmN1aXRJZCI6ImNyZWRlbnRpYWxBdG9taWNRdWVyeVYzLWJldGEuMCIsInByb29mIjp7InBpX2EiOlsiMzQxMzAwMzkwODI2MDM4MTU5MDE1NTM0Mzg4NjE2NjE0NDkxMzc2NTIyMDc1NTg2MzU1NjkyODI0Mzk1ODEzMDAxNzk5Mzg1NDM0OCIsIjE1MTQ3MDY1Mjk0ODU1Nzk2MTkzMTU3ODA0MzE5MDA1MTkyNzUyODEyNTIzOTIyMTg1ODQ5NjQ3MTY1NDUyNjQyNzc4NTYzMjE1NDgiLCIxIl0sInBpX2IiOltbIjE0NzU2MjM2MzIzNDQzMzU0OTE5MTA5MzMwNDIzMTAzMDE4ODQ4MjIwMDc1ODMyNzMwNDg4MzU0NTYzNjg5Njk1MDgxNjE2MzY4MzM5IiwiMTM1MTQyODk2NTg3NDM0MTk1NDYyNTQ3MzM1NDA5NzM0NjUzMjY5MTYyNzI3ODQ2MjUxMzE0NTE5MzEzOTM1MTE4MTU3MzA1NjMxMTEiXSxbIjgzOTQzODkxMzY2MTI1NTYxNDgzMzA3NDUyMjg3MTE3NTg4NDU4MTE0NjE4MTU4NDM2NzY0MDc4NzA2MTg3ODUzMzEwMDE5NzI3MzkiLCI1MTY0NjI0OTc0OTg4NDMwMDI3OTk2MjM3MDQyOTYyNDI2NzA3Mjc0Nzc3Mzg2ODU2NTY0Njk5MDU5MTU0NzA2MzQ1OTI1MjY3MjE5Il0sWyIxIiwiMCJdXSwicGlfYyI6WyI3NDI3NTQ4ODA3ODI1ODU1MDU3NjI1MTIxMjM4OTQxNjEzMjA4NDAzNTc5MzEwOTY3MDY4Mjk2OTMxNzQ3MTQ5Njc5NzA3ODg0OTEiLCIxNzI5ODE3NTY2NzMzNTMyNDk4ODM4NzM0Nzk3MTIxNDY1MzMxOTQwNjY1NzA1MDI5NjExMTg2NTc2MjQzMzAzMjAzMzQ2OTU1MTU0NiIsIjEiXSwicHJvdG9jb2wiOiJncm90aDE2IiwiY3VydmUiOiJibjEyOCJ9LCJwdWJfc2lnbmFscyI6WyIwIiwiMjE1NjgyMjU0Njk4ODk0NTgzMDU5MTQ4NDE0OTAxNzUyODAwOTM1NTUwMTUwNzEzMjk3ODczNzU2NDE0MzEyNjI1MDkyMDgwNjUiLCI0NDg3Mzg2MzMyNDc5NDg5MTU4MDAzNTk3ODQ0OTkwNDg3OTg0OTI1NDcxODEzOTA3NDYyNDgzOTA3MDU0NDI1NzU5NTY0MTc1MzQxIiwiMCIsIjAiLCIwIiwiMSIsIjEiLCIyNTE5MTY0MTYzNDg1Mzg3NTIwNzAxODM4MTI5MDQwOTMxNzg2MDE1MTU1MTMzNjEzMzU5NzI2NzA2MTcxNTY0MzYwMzA5NjA2NSIsIjEiLCI0NDg3Mzg2MzMyNDc5NDg5MTU4MDAzNTk3ODQ0OTkwNDg3OTg0OTI1NDcxODEzOTA3NDYyNDgzOTA3MDU0NDI1NzU5NTY0MTc1MzQxIiwiMTcwNTYwMDE0OCIsIjE5ODI4NTcyNjUxMDY4ODIwMDMzNTIwNzI3MzgzNjEyMzMzODY5OSIsIjEiLCIwIiwiMyIsIjEiLCI5OSIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIl19LHsiaWQiOjIsImNpcmN1aXRJZCI6ImxpbmtlZE11bHRpUXVlcnkxMC1iZXRhLjAiLCJwcm9vZiI6eyJwaV9hIjpbIjE1MzY2OTk0OTcyNzMzNTM0MTA2ODUwOTk5MDI2MjgzODkwMTgyMjcyOTQyNjQxNzUyMzc1MDM4ODcwMjc3Mzg4MDIxNTI5MDk0MDMiLCIxMTE1ODIyMzYwNTY3NTg2NTgyNTc3ODU4ODM2MTk1Nzc5MzMxMDg5MDA1MTkwNTg0NDk4MTM4MzA5OTcxNDA1NjY1Mjg4MjU2MTEzNCIsIjEiXSwicGlfYiI6W1siMTAxODU0OTk2NTE1MzUxODUzMDI5MzEwMjI4NTA5MTM1NTkyOTU5MDQ1ODIwNDY5NzkzNDQyMjQ4MDA1MTQyNTM1NTE3MDA5MTM0NTUiLCIyMTMxMzYwNDY4Mzk4MjY3MDA0MzUyMzE3ODg4NzQ3OTI4NDc3MjczOTkxMDEzNTUwNDE1ODcxODM5NjczMjAxOTI4ODE4MzIzMTM2MCJdLFsiMTM1MTYxNTAyNDI5NzEyMDYzOTEzNzMzNTEyMzMxMjg3NjE3OTg3MDExOTYzNzI0MjE1NTk1NDMzNzY3MjgwOTI4OTI2NzQ5MTU4OTciLCIyMDkxMzI4MzY1MTk3NjkzMjQ4MzQyNTQ3NDQyNzE1ODQ1MzA1OTU0MzExMjA3MTEzNTc1Mjc2MjE0OTMzODI3NDMzNzUxNTI5NTgyMCJdLFsiMSIsIjAiXV0sInBpX2MiOlsiMTY1OTg2NDcwNzIyMTczMjMzNDQzMTYzNjcwMjk0Mzc3MDE5ODA2MDU1NDg0MTExOTIwODQ1OTYzNDQ1NDkwNzA1MzU1MDcyNjIxOTQiLCIzMTUxMzY4NDcyNzA2NDA0MDY2NzgxMTgyODQyNzM1Mzk3NDQyNjE0MTgyMjc4NzM2NDA4NzExMTI5MTI2MzEwNDQ4NTg5ODU3NDYyIiwiMSJdLCJwcm90b2NvbCI6Imdyb3RoMTYiLCJjdXJ2ZSI6ImJuMTI4In0sInB1Yl9zaWduYWxzIjpbIjYxMjA0MzM3MDM3NzE4MjE2NjUyOTkxMjI4NjM4MTA2NjIzNTg0NzA1OTMzOTMxMDA2NDI2NjkzMjEyOTY0MzM0OTE0MTEwNjA4NjgiLCIxIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjEwMzQxNTc0NDQ4Mzg2NDg1MzM4MTI2MjEyNjk0Nzg5MjI0Njc2MjYxNzk4MTQwMTMyMDQ2NDk2MjA0NzMwNDQyNzQ2NzA3NzQzMzUwIiwiMTQ0NjA3Njc5OTUwMjA0NzgwOTM1MzMxNDE2MzExODMwNjM4MTMyMTk4Njk1OTI0NDcwMzgzODE1MTE4ODEyMzM3NjA2MjIyMDg3MiIsIjM2NDI3NzM5NDA2MDE5NzI0MDg2NzI5OTM0ODE0MDU2MjgxNjE4Mjc1MTE2MjI3MDE1ODAxNDIyNDI2OTExMjcwMjExMTk4MTA1OTYiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMSIsIjEiLCIxIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCJdfSx7ImlkIjozLCJjaXJjdWl0SWQiOiJjcmVkZW50aWFsQXRvbWljUXVlcnlWMy1iZXRhLjAiLCJwcm9vZiI6eyJwaV9hIjpbIjIxMTgyODU0ODU2MDM1Mzc4NjU2NTQwNzI0ODM2MDk1NTcxMzQxNjg1OTg4NDU2NjI1OTgwNjQxNzE2OTA0NDYwMjY0MjYzODg3Nzc0IiwiMTM3NDk1NDgyMjUzODgxMzQzNjU5NDE1MTAxNjIwNzI2NzU0MTQ0NDcyMDIyOTU2MzAwNTczMDE1ODM3NTg1MTc2NjA0NDk3MjY5MjgiLCIxIl0sInBpX2IiOltbIjE1MTY4NjIwNTc0NTI5OTQ2Mjg2OTkyOTQwOTkwMTc4Mjg0NzMzNjIxODYxNDYzMDA5ODk0OTY1MjcyMDI1MDY0NzU0NjM3NTM2MDc5IiwiMTM2ODUwOTA1MzU4Nzk2OTY0MTk3OTk1MjIzODIzMTU5NzY4NjIwNDg0NzI1NjU4OTg4MzE5MDY0MjkwNzY2MTI2MTg5NDg1MjIzNDEiXSxbIjEwNzA1MzI1MzQyMjA4NzU2NjIxMDUzNTEyODI3OTM5MzAzMTQwNjMxMDUxMjY2MjQ1MTQ3NDYwNDc5NzYxNjY5MTg0NDEzMzYzMDciLCIxOTcwODUxMDAzNjUzNDU4ODA2OTg2NTY0OTM2NjA3Mjk1ODA2OTE2NjA5Mjc0OTYwNDI4Njc0MzkzMDA0OTY3ODMwNzY5OTA5NzU3NyJdLFsiMSIsIjAiXV0sInBpX2MiOlsiMTE3ODg3MjY5MDE3ODMzNTY1ODI2MDY5NjQ0NDkzNzM1MDU5NzMyOTU1MTM4MTUzNDg4NTE5NzMzNjI2MzY0NzExNjU0NTk3MjMxNTkiLCIxODczNzU1MTI2Nzg0NTUxMjgxMzY0MDY4MzcwNTY3MTEzODM2MDM1MDgwNDE5NTc4MzE3NzM1NDEzOTc3OTg0OTE3NTIyODE5NjI3MyIsIjEiXSwicHJvdG9jb2wiOiJncm90aDE2IiwiY3VydmUiOiJibjEyOCJ9LCJwdWJfc2lnbmFscyI6WyIxIiwiMjE1NjgyMjU0Njk4ODk0NTgzMDU5MTQ4NDE0OTAxNzUyODAwOTM1NTUwMTUwNzEzMjk3ODczNzU2NDE0MzEyNjI1MDkyMDgwNjUiLCI0NDg3Mzg2MzMyNDc5NDg5MTU4MDAzNTk3ODQ0OTkwNDg3OTg0OTI1NDcxODEzOTA3NDYyNDgzOTA3MDU0NDI1NzU5NTY0MTc1MzQxIiwiNjEyMDQzMzcwMzc3MTgyMTY2NTI5OTEyMjg2MzgxMDY2MjM1ODQ3MDU5MzM5MzEwMDY0MjY2OTMyMTI5NjQzMzQ5MTQxMTA2MDg2OCIsIjAiLCIwIiwiMSIsIjMiLCIyNTE5MTY0MTYzNDg1Mzg3NTIwNzAxODM4MTI5MDQwOTMxNzg2MDE1MTU1MTMzNjEzMzU5NzI2NzA2MTcxNTY0MzYwMzA5NjA2NSIsIjEiLCI0NDg3Mzg2MzMyNDc5NDg5MTU4MDAzNTk3ODQ0OTkwNDg3OTg0OTI1NDcxODEzOTA3NDYyNDgzOTA3MDU0NDI1NzU5NTY0MTc1MzQxIiwiMTcwNTYwMDE3MSIsIjIxOTU3ODYxNzA2NDU0MDAxNjIzNDE2MTY0MDM3NTc1NTg2NTQxMiIsIjAiLCIxMjk2MzUxNzU4MjY5MDYxMTczMzE3MTA1MDQxOTY4MDY3MDc3NDUxOTE0Mzg2MDg2MjIyOTMxNTE2MTk5MTk0OTU5ODY5NDYzODgyIiwiMCIsIjEiLCIxNzAyMjUyODAwMDAwMDAwMDAwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiXX1dfSwiZnJvbSI6ImRpZDppZGVuMzpwb2x5Z29uOm11bWJhaTp3dXc1dHlkWjdBQWQzZWZ3RXFQcHJucWppTkhSMjRqcXJ1U1BLbVYxViIsInRvIjoiZGlkOmlkZW4zOnBvbHlnb246bXVtYmFpOnd6b2t2WjZrTW9vY0tKdVNiZnRkWnhURDZxdmF5R3BKYjNtNEZWWHRoIn0.eyJwcm9vZiI6eyJwaV9hIjpbIjQyOTY1NTE0NjUxMDkzODE5NjQ2MDgzOTYwNDcyMDA2MDc1NjQ5MzgwODE4NjA0NjQ0MTIwMDEzOTE4MjYyMTM4NTU0MjMyNTc4OCIsIjIwODAxMjYwNTAyNzg2MTM4MDA3MjY1NDY1MjI3MjkzNzIyNDQ3ODkzNDEwMzYxODk4MzYxNTg4NTMyODU2MTg4NTM2NTI0NzE3NzciLCIxIl0sInBpX2IiOltbIjczNDIyNDI5NDI4NzE5Njc3NTc5NDg5ODIzMzE2MDgwMjk4OTkwMjg1OTM5NDgwMTExMzA4MjY3NzU4NjA0MTExMTUxMTYwMjkxMiIsIjE5NTcxMTQxMTAzOTIzMTg0ODMxNjUzMTI2MDAzNTg5MTI2NjcwMjIyNjg3Mzk3MTU0NjEyMzkxMDQzMjY3ODk5MDUyNTEwOTg3ODU1Il0sWyIyOTYyNDc2MDY4MTYwNzIzNzQ1MTE1Mjk4MDM0NDMxOTE5OTA4MzcyNDI1ODgwMjAzMjY0MTU2NjM5NDY0NzE3NjM4MDI2MTQwMTIyIiwiMTE3MzgyMTk0NDEwNzI1OTEzODY0NzAwMDQ4ODMzNDcwNDc2MDg2NDQ2MjM5OTI3NTI0NTg3NzYyNjgwOTIyMDQ1MDA0MDU5OTE0NzAiXSxbIjEiLCIwIl1dLCJwaV9jIjpbIjE5MDQ0MjA1NDU2OTM1NDYwNDE1NDE1MzQ0MTE5ODAzMjM1Mjc4MDQ3NzEwMTczODQyNzk0ODU4MDE4Mzg2NzQ2MDg4MzgwMTIyODk0IiwiNjk4MjExMjI1ODEyMzY4OTU4NjE0MDgzNzkxMzkzMTc5NzM1NDY2ODQwMTU4NzEyMTIyMjY3NzExMTQ1NzYxNzI3Mjc4NTk2ODM5OSIsIjEiXSwicHJvdG9jb2wiOiJncm90aDE2IiwiY3VydmUiOiJibjEyOCJ9LCJwdWJfc2lnbmFscyI6WyIyMTU2ODIyNTQ2OTg4OTQ1ODMwNTkxNDg0MTQ5MDE3NTI4MDA5MzU1NTAxNTA3MTMyOTc4NzM3NTY0MTQzMTI2MjUwOTIwODA2NSIsIjM1Mzk1NDg1NTE2OTc5MzEyNzQzMzU0OTg0NTU3NDYyMTcyMTczMDI0OTc3NTUyNjM4OTMzNjY2Mzk1NDU0NTk0ODQzODUxMzA1MDciLCIwIl19';

    const verifier = await Verifier.newVerifier({
      stateResolver: resolvers,
      circuitsDir: path.join(__dirname, './testdata'),
      documentLoader: schemaLoader
    });

    await verifier.fullVerify(tokenString, authRequest);
  });
});
