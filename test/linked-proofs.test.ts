import { AuthorizationRequestMessage } from '@0xpolygonid/js-sdk';
import { Verifier } from '@lib/auth/auth';
import { resolvers, schemaLoader } from './mocks';
import path from 'path';
import { PROTOCOL_CONSTANTS } from '@0xpolygonid/js-sdk';

describe('Linked proofs verification', () => {
  it('should verification pass', async () => {
    const authRequest: AuthorizationRequestMessage = {
      id: '5b417f75-e007-43c1-a04f-ccbf4e93c96c',
      typ: PROTOCOL_CONSTANTS.MediaType.PlainMessage,
      type: 'https://iden3-communication.io/authorization/1.0/request',
      thid: '5b417f75-e007-43c1-a04f-ccbf4e93c96c',
      body: {
        callbackUrl: 'http://localhost:8080/callback?id=1234442-123123-123123',
        reason: 'reason',
        message: 'mesage',
        did_doc: {},
        scope: [
          {
            id: 1,
            circuitId: 'credentialAtomicQueryV3',
            optional: false,
            query: {
              proofType: 'BJJSignature2021',
              allowedIssuers: ['*'],
              type: 'KYCAgeCredential',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-nonmerklized.jsonld',
              credentialSubject: {
                documentType: {
                  $eq: 99
                }
              }
            }
          },
          {
            id: 2,
            circuitId: 'linkedMultiQuery3',
            optional: false,
            query: {
              groupId: 1,
              proofType: 'Iden3SparseMerkleTreeProof',
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                documentType: {
                  $eq: 1
                },
                position: {
                  $eq: 'boss',
                  $ne: 'employee'
                }
              }
            }
          },
          {
            id: 3,
            circuitId: 'credentialAtomicQueryV3',
            optional: false,
            query: {
              groupId: 1,
              proofType: 'BJJSignature2021',
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                hireDate: {
                  $eq: '2023-12-11'
                }
              }
            }
          }
        ]
      },
      from: 'did:iden3:polygon:mumbai:wzokvZ6kMoocKJuSbftdZxTD6qvayGpJb3m4FVXth'
    };

    const tokenString =
      'eyJhbGciOiJncm90aDE2IiwiY2lyY3VpdElkIjoiYXV0aFYyIiwiY3JpdCI6WyJjaXJjdWl0SWQiXSwidHlwIjoiYXBwbGljYXRpb24vaWRlbjMtemtwLWpzb24ifQ.eyJpZCI6ImM1OTBlMmVlLWFiODQtNDc3Yi05NWQxLWE3YzNkMWQyYWMzNCIsInR5cCI6ImFwcGxpY2F0aW9uL2lkZW4zLXprcC1qc29uIiwidHlwZSI6Imh0dHBzOi8vaWRlbjMtY29tbXVuaWNhdGlvbi5pby9hdXRob3JpemF0aW9uLzEuMC9yZXNwb25zZSIsInRoaWQiOiI1YjQxN2Y3NS1lMDA3LTQzYzEtYTA0Zi1jY2JmNGU5M2M5NmMiLCJib2R5Ijp7Im1lc3NhZ2UiOiJtZXNhZ2UiLCJzY29wZSI6W3siaWQiOjEsImNpcmN1aXRJZCI6ImNyZWRlbnRpYWxBdG9taWNRdWVyeVYzIiwicHJvb2YiOnsicGlfYSI6WyIxODU4NTIwODcxMTg1MzI4MDg1ODI3MDIxNTg4MjYxMTcxMDA3OTI0MDA4NzM0MTM1NDM2NDE5NzU1ODk3MDk4NjU1ODMzNzM4ODE0MSIsIjE0MjYwNjk0NTE0MDY4Nzc1MzkwOTgxNzc3NDYwODYzOTYzNDU3MDA3MzcxNjc4OTc4MTI2MjE4NzY2MDU3NTU0ODI5MTEyMTQ0NDc1IiwiMSJdLCJwaV9iIjpbWyIyMTI2NDM3NTU2MDIzNTE2NDAwODQzMTU2ODMwMTIwNTI3NjQxMjkwMjg0Nzk2MzUxODAwMzU0MDg3ODk3MjYyNjczNjEyNzMzOTk5NyIsIjEzNjYyMjUxNjcyODYxNDMzMTMwNjE0OTM4MzkxMzMwMjA2OTEwNzU4OTc5NzI1NzE2MzAyNjYwNjA0NDI5OTE2NzU5NTM4MDI4MTQiXSxbIjE5MzAwMTY4ODMzNTU2NTY0NzczODYwOTU1NTc4MjUzNzQ5MzkxNjgzODk2Mzc0MzY4MjYwODk3MzYzNTg5NDcwODcwMzkyNTA0NTczIiwiOTI5OTY5MTk3MDYwODk0NDE0ODE2NjUwNDUyODMxMDMwMTU2ODI0OTQ2NjQ3NTI4NzA0ODk0NjcwOTMwMDU1OTk5NzEwNjAxNzIzNCJdLFsiMSIsIjAiXV0sInBpX2MiOlsiMTI1MTE4MDc0NTc0MTI5MTMyOTI5MzAzNjg5OTI4OTA2NjczMTI3NjE4NzM2MjkzNDQ1MzM0NjA1ODI0ODg4MjM2MDA1NzkxMTIxMjYiLCI2NzAxNjIyMDQ0MTM0NzEzMjQ3MDUyNDE5OTMyNDAxMzg3OTM3ODU3ODcwNzk1ODY0ODY2MTE4MDc4OTYzMzIyMzA3NTQ2NDA0NzA1IiwiMSJdLCJwcm90b2NvbCI6Imdyb3RoMTYiLCJjdXJ2ZSI6ImJuMTI4In0sInB1Yl9zaWduYWxzIjpbIjAiLCIyMTU2ODIyNTQ2OTg4OTQ1ODMwNTkxNDg0MTQ5MDE3NTI4MDA5MzU1NTAxNTA3MTMyOTc4NzM3NTY0MTQzMTI2MjUwOTIwODA2NSIsIjQ0ODczODYzMzI0Nzk0ODkxNTgwMDM1OTc4NDQ5OTA0ODc5ODQ5MjU0NzE4MTM5MDc0NjI0ODM5MDcwNTQ0MjU3NTk1NjQxNzUzNDEiLCI3NjY1ODkwODc0MDk2OTUyMjM2MzYzMzc4MjA4MDg0MDIzNzI5NTgyMDc5MTQ0MTU0MzAxOTcyMDAxNDQ3NzAzNTg0MTY1Nzk1MTAzIiwiMCIsIjAiLCIxIiwiMSIsIjI1MTkxNjQxNjM0ODUzODc1MjA3MDE4MzgxMjkwNDA5MzE3ODYwMTUxNTUxMzM2MTMzNTk3MjY3MDYxNzE1NjQzNjAzMDk2MDY1IiwiMSIsIjQ0ODczODYzMzI0Nzk0ODkxNTgwMDM1OTc4NDQ5OTA0ODc5ODQ5MjU0NzE4MTM5MDc0NjI0ODM5MDcwNTQ0MjU3NTk1NjQxNzUzNDEiLCIxNzAyNjI1NjgyIiwiMTk4Mjg1NzI2NTEwNjg4MjAwMzM1MjA3MjczODM2MTIzMzM4Njk5IiwiMSIsIjAiLCIzIiwiMSIsIjk5IiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiXX0seyJpZCI6MiwiY2lyY3VpdElkIjoibGlua2VkTXVsdGlRdWVyeTMiLCJwcm9vZiI6eyJwaV9hIjpbIjgwNzUwMzYyMzQwMzcxODU3MjI3MTM0ODc4NjAwMjM3NjI0NDkxNzEwOTc2MzkyMTAzNTQ3MDE5NzQ1NzY0MDg0ODU2NjM5NTY3NzMiLCIxODU1ODg0NzAwMTk3OTI4MzQyMjQ3MDc0NDExMTExMjEyODQ4MjM3Mjg5NzgzNDQ5NTg2NDMwNzcyNDM5OTM3MDg1MDA4MTA0MjgwMCIsIjEiXSwicGlfYiI6W1siMTk4NzI4NDE5MTQzOTE2MDI3NDM4ODkzNDQ4ODM5NzY1OTY5Mjg2MTQ0NTI3OTg1MDUyNzE5MDg2NzY5OTgwMjg4MTU1OTQ2MjQyMzciLCIzODI5ODU4OTA1MDYzMTM0MzA1MTQ0Mjg0NDkxMzQ0MTUwNDgwNTU4NjgzMDU3NDE4NTYzMDcxNjM1NjA4NDU3MzcyNzc3NjI3MzE3Il0sWyIxMTIwNjEzMTYyNjIxOTQxODEzODQzNzY4Njk3MjAwMzEyNzI3MTY1NzcwMDgxNzI1MDM1MDI1NTg5NjEwMjI4OTEyODcxNzM1OTU5MyIsIjE4NjkwNDQ3ODIxOTQ2NjAxMjcwNjgwMTc2MDU5NTk3MjIyMzU4ODQ2NzcxNzI3NjAzNzUwMDkwNTg1NjUwNTM0MjI5NDYyMjU3MTc4Il0sWyIxIiwiMCJdXSwicGlfYyI6WyIxMjA1OTE4OTE0NDI3MzUxMTc5OTYyODI0NzgzMjA0MTQ2Mjk1NDgwNjMyMDA2NTUyMjQ4NzczMzU2NTQ5NjUyNTU3OTA5ODI4NDU2MSIsIjE0NTc5OTAzNzY5OTgxODM1MTU3MTE4NzgzMTMzNjk4NTE3MzY5NDg0MjU3NDMzODYyNTQzMzUzMjIxNjg1MDk3OTQ5NDUwMzEzNzIxIiwiMSJdLCJwcm90b2NvbCI6Imdyb3RoMTYiLCJjdXJ2ZSI6ImJuMTI4In0sInB1Yl9zaWduYWxzIjpbIjE4NTgxMzEwOTYwOTU3OTYyNzg4OTA0NTc0NzU1Mzg2MjA5MTgyMzc4ODE2MTE2MjI2NTkwMjMxOTkwNDgyMDQwMDE3MDcwODk1NjQxIiwiMSIsIjAiLCIwIiwiMCIsIjEwMzQxNTc0NDQ4Mzg2NDg1MzM4MTI2MjEyNjk0Nzg5MjI0Njc2MjYxNzk4MTQwMTMyMDQ2NDk2MjA0NzMwNDQyNzQ2NzA3NzQzMzUwIiwiMTQ0NjA3Njc5OTUwMjA0NzgwOTM1MzMxNDE2MzExODMwNjM4MTMyMTk4Njk1OTI0NDcwMzgzODE1MTE4ODEyMzM3NjA2MjIyMDg3MiIsIjM2NDI3NzM5NDA2MDE5NzI0MDg2NzI5OTM0ODE0MDU2MjgxNjE4Mjc1MTE2MjI3MDE1ODAxNDIyNDI2OTExMjcwMjExMTk4MTA1OTYiLCIxIiwiMSIsIjEiXX0seyJpZCI6MywiY2lyY3VpdElkIjoiY3JlZGVudGlhbEF0b21pY1F1ZXJ5VjMiLCJwcm9vZiI6eyJwaV9hIjpbIjk1NTU1NTUxOTcyMjQzODk4MTU1NzU4NTkyNDg4NjAxNDgzMTQwMDUxNDU4NzYzMDc0NTA2NjA1MTE2MDU4NjEzNTIyNjc3Nzc2NTMiLCIxNjQxNTI3MTgwNzM2OTI5ODkzMDYyMzI4NTU1NDU3NDU0NjIzODMzMDk2MjU2NTczMDU1ODE5NzY1NjA0Mjc1NzA3NjY0ODk5MjI4OCIsIjEiXSwicGlfYiI6W1siMjAxMTM2MDI5NjU3MDM3Njk4NjM1NTY4MDczNjM4NjA5NjUyODEyODU0MTAzNjg1NTE0NjI4MTgyNjU5MDMwMDk2Nzk5ODQwMTc3MyIsIjI3MDE0MTIyODg4ODExMTEwOTAxNzY5MTMzNDY5OTM5MDU0MjY5NzAzOTgwMTk3ODgyNDgyNTQ4ODMxNzkxNDQ2NTMyNjIyMDkzNCJdLFsiMTc5MDIzMTA0MDM1MzU3NDYyODUxNjg1OTMwODA4MTU2MDgyNTM4NDI3Nzc5NTQ2OTIwMjQ0NzIzMjE4ODE3MDYyMTQyNTEyNDA3NiIsIjE2ODQ4OTM3MjE3ODA2NjkwMDkwNjI0ODY2MjgwNzY1MDM5ODU5NzY5NjAzMTA1NzExODI3MjMwMTYwNDQ2MzI4NTA3NTc3NzM2NTYxIl0sWyIxIiwiMCJdXSwicGlfYyI6WyI1MzcyMDQ4NTA4NzU3MjQyODIyMzkzOTkxMDg5MzE3NTkwNzIyNjc5MDI2Mzk1MDIwNTEyNzY0ODU2NTQ0NDUyNTYyOTM1MTEwNTE2IiwiMTgxMjU1NDYyODA4NDAzNjEyMzk5MDU3OTIyNjIxODUzNjMxMTUzNTU4MjAyOTA2MTc1ODY1OTA4NDgyNzI1NDY4MzQwNDIwNzg2MjAiLCIxIl0sInByb3RvY29sIjoiZ3JvdGgxNiIsImN1cnZlIjoiYm4xMjgifSwicHViX3NpZ25hbHMiOlsiMSIsIjIxNTY4MjI1NDY5ODg5NDU4MzA1OTE0ODQxNDkwMTc1MjgwMDkzNTU1MDE1MDcxMzI5Nzg3Mzc1NjQxNDMxMjYyNTA5MjA4MDY1IiwiNDQ4NzM4NjMzMjQ3OTQ4OTE1ODAwMzU5Nzg0NDk5MDQ4Nzk4NDkyNTQ3MTgxMzkwNzQ2MjQ4MzkwNzA1NDQyNTc1OTU2NDE3NTM0MSIsIjE4NTgxMzEwOTYwOTU3OTYyNzg4OTA0NTc0NzU1Mzg2MjA5MTgyMzc4ODE2MTE2MjI2NTkwMjMxOTkwNDgyMDQwMDE3MDcwODk1NjQxIiwiMCIsIjAiLCIxIiwiMyIsIjI1MTkxNjQxNjM0ODUzODc1MjA3MDE4MzgxMjkwNDA5MzE3ODYwMTUxNTUxMzM2MTMzNTk3MjY3MDYxNzE1NjQzNjAzMDk2MDY1IiwiMSIsIjQ0ODczODYzMzI0Nzk0ODkxNTgwMDM1OTc4NDQ5OTA0ODc5ODQ5MjU0NzE4MTM5MDc0NjI0ODM5MDcwNTQ0MjU3NTk1NjQxNzUzNDEiLCIxNzAyNjI1Njg4IiwiMjE5NTc4NjE3MDY0NTQwMDE2MjM0MTYxNjQwMzc1NzU1ODY1NDEyIiwiMCIsIjEyOTYzNTE3NTgyNjkwNjExNzMzMTcxMDUwNDE5NjgwNjcwNzc0NTE5MTQzODYwODYyMjI5MzE1MTYxOTkxOTQ5NTk4Njk0NjM4ODIiLCIwIiwiMSIsIjE3MDIyNTI4MDAwMDAwMDAwMDAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCJdfV19LCJmcm9tIjoiZGlkOmlkZW4zOnBvbHlnb246bXVtYmFpOnd1dzV0eWRaN0FBZDNlZndFcVBwcm5xamlOSFIyNGpxcnVTUEttVjFWIiwidG8iOiJkaWQ6aWRlbjM6cG9seWdvbjptdW1iYWk6d3pva3ZaNmtNb29jS0p1U2JmdGRaeFRENnF2YXlHcEpiM200RlZYdGgifQ.eyJwcm9vZiI6eyJwaV9hIjpbIjE3OTQ3MzY0OTg4OTgwMzU1MDUzMDM0ODgyNDAwMDA1NDIzMjcxNDU5MjU5NTgzMjA3OTQwNTcxNjk1NjE1NTkzNjU5NTMxNDk2MjIiLCIyMjI3Mzg1Nzg3MTQxMDMzODY5OTM2NTY3MDI0NTc0OTQzNTI2Njc3NTU0NTc3MDIwNzk3ODk0NjgxODAyMjM5NjEyMjE2ODEzMDc3IiwiMSJdLCJwaV9iIjpbWyIxNTU5MjA4NTYwNjU3MzQyOTE4NTI5MzcwODA3MzMwMDc2MjIxNTEzODMxODA1NTIyMzkyOTMwNjkzNDMxNjE2MDA0MDM3Mjg5NjY2NyIsIjE2MTQ0NDU0NTYzMjI2MDIxMDkwNjE5MDE5MTQ0NDQzNDY5NDY5MjE2NDAyMjc4MzMxNjQ2Nzg1NTk5MjkzNzk0MzI2OTIwNjAyNDYzIl0sWyI0ODU4MDkzMTgxNjg4NTY4NzM1OTY0OTMwNzYwODE5MzA3MzEwNzg0MzU1OTE4NjE2NTY4Mzg2MzIxNjQ5MDgzMTk3NzE2MDI2MDYzIiwiMjA3OTYyMTQ0OTM4MjE1MTQ3MTg1MzIwNzgwMzY5Nzk4OTk1NDY4NTY3MTk0MDI1Nzg4NTE3NTYxMzY4MjY2NTg1MzIxNzE4NDA5MjkiXSxbIjEiLCIwIl1dLCJwaV9jIjpbIjE2ODc2NjE3OTA5MTg2MDY3MDcxNjI0NDc2MjU2MjMxNTI5ODI5NzgyOTMyOTg4MjI3MzY4NTk5ODA5MDY1MzEzMTIzNjI4NjQzNjkxIiwiMTAwNzgxNzk3MTc2OTE2NDI4MzgyNjAzMzUyNDE0NTIyNjk4NTUxNDc3NjAxNDYzMTY2MDIxMDU1MjM4NTE2NDA1MTI1OTY2OTU5OTMiLCIxIl0sInByb3RvY29sIjoiZ3JvdGgxNiIsImN1cnZlIjoiYm4xMjgifSwicHViX3NpZ25hbHMiOlsiMjE1NjgyMjU0Njk4ODk0NTgzMDU5MTQ4NDE0OTAxNzUyODAwOTM1NTUwMTUwNzEzMjk3ODczNzU2NDE0MzEyNjI1MDkyMDgwNjUiLCI5NzM4MjEzMjc0OTcyODM5NTQ0MzgxNzE3NDIwMDAxNDAzNDc4MTM4NzU5MjQyOTQ3NjIyNTI4Mjk5MjA1NDUyMjY1MDE1Mjk0MjU3IiwiMCJdfQ';

    const verifier = await Verifier.newVerifier({
      stateResolver: resolvers,
      circuitsDir: path.join(__dirname, './testdata'),
      documentLoader: schemaLoader
    });

    verifier.fullVerify(tokenString, authRequest);
  });
});
