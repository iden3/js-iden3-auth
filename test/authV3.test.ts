import { AuthorizationRequestMessage } from '@0xpolygonid/js-sdk';
import { Verifier } from '@lib/auth/auth';
import { resolvers, schemaLoader } from './mocks';
import path from 'path';
import { MediaType } from '@0xpolygonid/js-sdk/dist/types/iden3comm/constants';

describe('Linked proofs verification', () => {
  it.only('should pass', async () => {
    const authRequest: AuthorizationRequestMessage = {
      id: '4f3fd521-746b-4dee-b471-45a96a8ca225',
      typ: MediaType.PlainMessage,
      type: 'https://iden3-communication.io/authorization/1.0/request',
      thid: '4f3fd521-746b-4dee-b471-45a96a8ca225',
      body: {
        callbackUrl: 'http://localhost:8080/callback?id=1234442-123123-123123',
        reason: 'reason',
        message: 'mesage',
        did_doc: {},
        scope: [
          {
            id: 1,
            circuitId: 'credentialAtomicQueryV3',
            optional: false,
            query: {
              proofType: 'BJJSignature2021',
              allowedIssuers: ['*'],
              type: 'KYCAgeCredential',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-nonmerklized.jsonld',
              credentialSubject: {
                documentType: {
                  $eq: 99
                }
              }
            }
          },
          {
            id: 2,
            circuitId: 'linkedMultiQuery3',
            optional: false,
            query: {
              groupId: 1,
              proofType: 'Iden3SparseMerkleTreeProof',
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                documentType: {
                  $eq: 1
                },
                position: {
                  $eq: 'boss'
                },
                salary: {
                  $eq: 200
                }
              }
            }
          },
          {
            id: 3,
            circuitId: 'credentialAtomicQueryV3',
            optional: false,
            query: {
              groupId: 1,
              proofType: 'BJJSignature2021',
              allowedIssuers: ['*'],
              type: 'KYCEmployee',
              context:
                'https://raw.githubusercontent.com/iden3/claim-schema-vocab/main/schemas/json-ld/kyc-v101.json-ld',
              credentialSubject: {
                hireDate: {
                  $eq: '2023-12-11'
                }
              }
            }
          }
        ]
      },
      from: 'wzokvZ6kMoocKJuSbftdZxTD6qvayGpJb3m4FVXth'
    };

    const tokenString =
      'eyJhbGciOiJncm90aDE2IiwiY2lyY3VpdElkIjoiYXV0aFYyIiwiY3JpdCI6WyJjaXJjdWl0SWQiXSwidHlwIjoiYXBwbGljYXRpb24vaWRlbjMtemtwLWpzb24ifQ.eyJpZCI6IjVmOWZhZjI2LWE3NDQtNGMwOC1hYTI5LWQwOGZjM2RhOWZhMCIsInR5cCI6ImFwcGxpY2F0aW9uL2lkZW4zLXprcC1qc29uIiwidHlwZSI6Imh0dHBzOi8vaWRlbjMtY29tbXVuaWNhdGlvbi5pby9hdXRob3JpemF0aW9uLzEuMC9yZXNwb25zZSIsInRoaWQiOiI0ZjNmZDUyMS03NDZiLTRkZWUtYjQ3MS00NWE5NmE4Y2EyMjUiLCJib2R5Ijp7Im1lc3NhZ2UiOiJtZXNhZ2UiLCJzY29wZSI6W3siaWQiOjEsImNpcmN1aXRJZCI6ImNyZWRlbnRpYWxBdG9taWNRdWVyeVYzIiwicHJvb2YiOnsicGlfYSI6WyIyMDI5MzY2NjA1Nzk0MDA2NzY2Mzg4NTY5NDI4NzM1MTQ3NjIyOTkwOTYzMjAyNDI5MjQzOTE2NTI5NDkyOTk3MTM1MDY3NDQ4OTE1NCIsIjEwNjQ2MDk0Mjk3MTY0NDAyMjYzODYyNDM1MzI4NzQ0NjQ1NTAwNzcwNjA5NDMwNjcyNDE2NDg0MTg4OTAyNDMxNjc0MDA0MjIzMDA5IiwiMSJdLCJwaV9iIjpbWyIyMDY3Mjc4NTY2NTM2MTE5NjcyMTA5ODc3MjM3OTE0MjA2ODQ1MTExOTk2NDIzMTg5NzAyNTM0NDU3NzU4MTgwNTIwODc2NjM2NTA0MiIsIjE3NDc2NTAyMzA0NjAzMDYyOTM4MTExOTU0OTc1NDkwMjk1MjEzNzE3ODc1NDI5NDUwMTE0MzI5MDk4NjkzMDA0MjIwODYxNTUyMzI0Il0sWyIxMTM0NTUxODE0MzI4Mjc3MzYyNDM3MzEwMjI1NTY4MDY0MTk3NDY4MjE1MzE2OTgxNjI0ODE5ODY1NzAyNjc4ODExNTI1MDg0NDE2NSIsIjE3OTc4NjE5NzExMDI3ODUyNjQ3MDc5NTkxODUxMjk2OTA4NDY0MTkwNDA1OTYzMTU5Njg5NDgwNzk3NzI1NzAyNzg5NTk5NjgzMjI4Il0sWyIxIiwiMCJdXSwicGlfYyI6WyIxOTA4NTI5MjE1OTYyNTczMDI1ODcxODUxNjA0OTE2OTMyNDUwOTU3MTQ2Njg1MTM4Mjc5NzE0MTUyNzczMjY3NTQzNzk5Nzc5MjQxNCIsIjE2MjI0NzA1NzQxODAxNDYxNzY0MzYwMTU1NzEyMDQ2OTc5ODQ5Mzg2NDM4NTY5NjgzNTgzMjA1MDM4MTA3Mjc5MTM5MDY3NzQ1MzQxIiwiMSJdLCJwcm90b2NvbCI6Imdyb3RoMTYiLCJjdXJ2ZSI6ImJuMTI4In0sInB1Yl9zaWduYWxzIjpbIjAiLCIyMTU2ODIyNTQ2OTg4OTQ1ODMwNTkxNDg0MTQ5MDE3NTI4MDA5MzU1NTAxNTA3MTMyOTc4NzM3NTY0MTQzMTI2MjUwOTIwODA2NSIsIjQ0ODczODYzMzI0Nzk0ODkxNTgwMDM1OTc4NDQ5OTA0ODc5ODQ5MjU0NzE4MTM5MDc0NjI0ODM5MDcwNTQ0MjU3NTk1NjQxNzUzNDEiLCI0NjI1MzM5ODg0OTEwODE0NzQyNzE5NDcyNjE2NzU4NzI0ODE2MTc1MjczMDc5MjMwNzAzNzM3MTc0MzE5MjU4MzUwMDMxNjQyMTA1IiwiMCIsIjAiLCIxIiwiMSIsIjI1MTkxNjQxNjM0ODUzODc1MjA3MDE4MzgxMjkwNDA5MzE3ODYwMTUxNTUxMzM2MTMzNTk3MjY3MDYxNzE1NjQzNjAzMDk2MDY1IiwiMSIsIjQ0ODczODYzMzI0Nzk0ODkxNTgwMDM1OTc4NDQ5OTA0ODc5ODQ5MjU0NzE4MTM5MDc0NjI0ODM5MDcwNTQ0MjU3NTk1NjQxNzUzNDEiLCIxNzAyMzgxMDk4IiwiMTk4Mjg1NzI2NTEwNjg4MjAwMzM1MjA3MjczODM2MTIzMzM4Njk5IiwiMSIsIjAiLCIzIiwiMSIsIjk5IiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiXX0seyJpZCI6MiwiY2lyY3VpdElkIjoibGlua2VkTXVsdGlRdWVyeTMiLCJwcm9vZiI6eyJwaV9hIjpbIjY1MTI5ODE4MTk1NDY5NzU2MzgzNDMxMTE0NTAzOTA5MDIxNDY4NDk4MjIwNDcyNjY1Nzk3NDcxOTEyODY2NDQ2NTE4MjI2NzU1MjIiLCIyMDYwNDk4NDI4MTY4MTY4ODYwMTc4MTM0MDI1MTI2NjQxMjgyMDY5MzM0MzQ5ODA1MDk1OTk3MDE1MDU0MzQ4ODQ0NzE3NDU5NTE2NCIsIjEiXSwicGlfYiI6W1siMTg0MzUwNDg0MTAwNTI5OTI2Nzc4MDQzNTk3NDkxOTU3MTMwODM3MjUwNzc1NTg4MTQ0ODcxMzM5NDY5NDczMzk4NjQ5NzA3NTk2MDgiLCIxNTk0NDEyMjM3Njc5MTE2NTc3NTUxMTg5NzkzMjI0NjQ1OTQ3OTI0MjI0OTg4MzI2NDQxMDMxMDM2MDAzMjA2Nzk1NTMzNzQzNTA3OSJdLFsiMTkxMzQ0MTA4MjE4OTY5NTk2NjA4MTM4NTYyNzk4NzE5MjUxMzYwMzk1Mjg3NDc3NTU5MTU2Mjk0Mjc0ODQ5NjE4NjI2NDQwMDI1MTYiLCIxMDY2NzQ2ODY2NjMxMDg4MzQ4NjQzNzczOTI5MzY4OTM0OTk5MDk5NzEzNjAzMTIwMTcxNzg5NDA5MzgzMjk3MDU2MDQ0MTg4OTE2NSJdLFsiMSIsIjAiXV0sInBpX2MiOlsiMTAyNzg4MjI1NDc0OTk4NDA4NDc1MzkwOTE1OTU5NjE1Mjk4NzkwMzcxNjg1OTM0NDIwNjY3Mjc5MDQyNDY4NjY0ODkwMTc4MjQ0MzMiLCIxNTY1Njc0MzczNjA4OTA4MzU4MTk2NTQ1NjI2NDU1MzM1Mzc2MTM2MjQ5MDI3MDI5NDQ2NDg5NDkyMDc4NTIyOTg5NzE1NTY3NTU0OCIsIjEiXSwicHJvdG9jb2wiOiJncm90aDE2IiwiY3VydmUiOiJibjEyOCJ9LCJwdWJfc2lnbmFscyI6WyIxNjk0MDA5MTUzOTMzNjUzNzQyNTU4OTkwNTI1NDkyOTgyNDY5NDg1ODY3Mjc5MjU2NDg5NzU1MjQyNDQ3ODA2NDEwNDIyOTYyMjEwOCIsIjEiLCIwIiwiMCIsIjAiLCIxMDM0MTU3NDQ0ODM4NjQ4NTMzODEyNjIxMjY5NDc4OTIyNDY3NjI2MTc5ODE0MDEzMjA0NjQ5NjIwNDczMDQ0Mjc0NjcwNzc0MzM1MCIsIjE0NDYwNzY3OTk1MDIwNDc4MDkzNTMzMTQxNjMxMTgzMDYzODEzMjE5ODY5NTkyNDQ3MDM4MzgxNTExODgxMjMzNzYwNjIyMjA4NzIiLCIxMzI0NTQyMTQ1NjczOTg2OTgxMjkwMTMxOTU2ODYzNTI0NTEyNjg1NDA1MjE0ODY2NjYzMjY3Njk2NTY3MTI3OTYxNzE3MDc4NzgyMSJdfSx7ImlkIjozLCJjaXJjdWl0SWQiOiJjcmVkZW50aWFsQXRvbWljUXVlcnlWMyIsInByb29mIjp7InBpX2EiOlsiMTI4OTk3NjIyMzYzODUxMjExNTYzMTczMjg3NTc4NjU2MTAzNzEyMjU0ODcyNjI2NjI3NjY3NTc3MTg4OTI1OTkyNDkyNTc5MTk0ODgiLCI2Mzc4MjE5MjI2NjI0Mjk4Mjk4MTAzODc3NjQwNDA5MDg1MjY2MDQ2NTUwNjg3NTI0NzA4MzUxNTMwODAwNzc5ODE3MTE0ODA0NTgzIiwiMSJdLCJwaV9iIjpbWyIxMDYzNjU1NTM2MzkxODY1MTUzMjgwNjk4NzUwMDMyOTc1NDg1OTE1MDA5OTE3ODQwMjYzOTM5OTEwMzI0NzE1NTgyNTg5MTI1NjU5MCIsIjE0MTc4MzIyOTg4NTE4MDYzNjYzOTk2NDk0ODU0MTczNjY3MTQwNjc1NTA5OTMyMzIzOTI0OTg5MTA5MDQ5NTE2NzM3Njc2NTI1NTg5Il0sWyIyMTA3NzY0MTk1MTM1MzUyODEwMTIzODk1NDYwODU1NTQwNzMxMDQwMTI5MzczNjExNTgyMjc3MTQ1NjA5NjY4MTI0OTA2MTQ2ODM2NSIsIjY0MzMzNTExMzg1NzEzMTQ0OTQ0MDYwNTI1MDE5NDEwMTEzMjQ0MTEzOTM2NDg5NTk3NzMwNDE5NTY4NjY2NzAwMDE2Mjk3NTc5MjMiXSxbIjEiLCIwIl1dLCJwaV9jIjpbIjE2Mzk0NTQ5MjQzOTA0MzMzNzg1MDY2MjA5NTMxNjY5MDk5MzExODYzNzM1NjE3ODQ0NTM1MzEyOTM4ODA3MDgzMjA1NDY5NjAzNDYxIiwiNTgzMzQ5ODUwNjIyMTEzNjk5ODczMDE2NzQxMjIxMzA1ODU1ODEyNzI0NzU5NjAwOTk2NzIyODY2Mjc5NzI2NzcwNzIwNjg3NDAwOSIsIjEiXSwicHJvdG9jb2wiOiJncm90aDE2IiwiY3VydmUiOiJibjEyOCJ9LCJwdWJfc2lnbmFscyI6WyIxIiwiMjE1NjgyMjU0Njk4ODk0NTgzMDU5MTQ4NDE0OTAxNzUyODAwOTM1NTUwMTUwNzEzMjk3ODczNzU2NDE0MzEyNjI1MDkyMDgwNjUiLCI0NDg3Mzg2MzMyNDc5NDg5MTU4MDAzNTk3ODQ0OTkwNDg3OTg0OTI1NDcxODEzOTA3NDYyNDgzOTA3MDU0NDI1NzU5NTY0MTc1MzQxIiwiMTY5NDAwOTE1MzkzMzY1Mzc0MjU1ODk5MDUyNTQ5Mjk4MjQ2OTQ4NTg2NzI3OTI1NjQ4OTc1NTI0MjQ0NzgwNjQxMDQyMjk2MjIxMDgiLCIwIiwiMCIsIjEiLCIzIiwiMjUxOTE2NDE2MzQ4NTM4NzUyMDcwMTgzODEyOTA0MDkzMTc4NjAxNTE1NTEzMzYxMzM1OTcyNjcwNjE3MTU2NDM2MDMwOTYwNjUiLCIxIiwiNDQ4NzM4NjMzMjQ3OTQ4OTE1ODAwMzU5Nzg0NDk5MDQ4Nzk4NDkyNTQ3MTgxMzkwNzQ2MjQ4MzkwNzA1NDQyNTc1OTU2NDE3NTM0MSIsIjE3MDIzODExMzMiLCIyMTk1Nzg2MTcwNjQ1NDAwMTYyMzQxNjE2NDAzNzU3NTU4NjU0MTIiLCIwIiwiMTI5NjM1MTc1ODI2OTA2MTE3MzMxNzEwNTA0MTk2ODA2NzA3NzQ1MTkxNDM4NjA4NjIyMjkzMTUxNjE5OTE5NDk1OTg2OTQ2Mzg4MiIsIjAiLCIxIiwiMTcwMjI1MjgwMDAwMDAwMDAwMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIiwiMCIsIjAiLCIwIl19XX0sImZyb20iOiJkaWQ6aWRlbjM6cG9seWdvbjptdW1iYWk6d3V3NXR5ZFo3QUFkM2Vmd0VxUHBybnFqaU5IUjI0anFydVNQS21WMVYiLCJ0byI6Ind6b2t2WjZrTW9vY0tKdVNiZnRkWnhURDZxdmF5R3BKYjNtNEZWWHRoIn0.eyJwcm9vZiI6eyJwaV9hIjpbIjE4MDI5MjU4MTkwMjgxMDg0MTQxODk4MTAwMDg4NzEyODA1ODc0MjIyNDYzODQ2MDI5MTI1ODkzMzgzMDAzMjU2MzQ0MTk2Mjg0OTAwIiwiMTQ5MTMxMTA0MTM4MjM5OTk4OTg1NDU1MDIyNzExODIyMTM5OTMyMDQ5MTA1MTQ4NzY4ODI1MzYyMzM5MTMyOTQ0MDQ0NjMyNjEyNSIsIjEiXSwicGlfYiI6W1siMTE3NzUxMDc0MzczMjY5NjA0MjgwNTI4ODUyOTg1Mjg4OTU3MTI4MTU1MDc2MDU3NTU2NDAxMDYxNTYyNTUwNDU5Mzk5Mzk5ODkwODciLCIzNjI0MTYxOTUzNDUzNDMyMzE0Njg1MjE5NTc0OTkxNzg4ODQxMzg3Njg1MzI4NDk5NzczMDI0MTIwMDA4Nzc2NzA3NDk3MTcxNzg5Il0sWyIyMTMyMjE3MDg2MDMxOTQxMzExMjgxNzMxNDQ4Njc5OTY4NjI3NDc3NTI0MzE1OTM3OTUzNDg0MDU1NTM5MTI3ODAxNjg3MjIxNzI1NiIsIjEwMDUxMDgzMDA3MjIxMzE5NTEyNTM1OTk5NTg0MjcyMzkwMjYxNTY2NDM2NDI1MDQ1NzM3NDc1ODQxNDU2MTE2OTYxOTAwNzMyMTgyIl0sWyIxIiwiMCJdXSwicGlfYyI6WyIyMTA3NzA1MzIzNDIzNTYwMDA3MzQ5NzExMDY0NjIxMDk2MDE4NjUyNTQ1ODcwODkwNjE3NTQ5Njk4NjI2NTY1OTY0NDM3MTY4MDc1MiIsIjE5Njc2MTAzMTEyNDQwNzA4NDM4MTE5NDkyMzI0ODY5MTE3MTE1ODc4OTQwMTUxNDEyOTYxMTM4MjU4ODY2NDY3OTQ1ODc5MjYwNDEiLCIxIl0sInByb3RvY29sIjoiZ3JvdGgxNiIsImN1cnZlIjoiYm4xMjgifSwicHViX3NpZ25hbHMiOlsiMjE1NjgyMjU0Njk4ODk0NTgzMDU5MTQ4NDE0OTAxNzUyODAwOTM1NTUwMTUwNzEzMjk3ODczNzU2NDE0MzEyNjI1MDkyMDgwNjUiLCIxMzkwOTY4OTgxNzg1MDA4ODQ5MDYyNjQ4OTMwNjIyMzczNzkxNjM5MjIzNTExMDI4MDI0MzQ2Njg3NDQ5NzM3MDYzNTIyNzY0MDcwNyIsIjAiXX0';

    const verifier = await Verifier.newVerifier({
      stateResolver: resolvers,
      circuitsDir: path.join(__dirname, './testdata'),
      documentLoader: schemaLoader
    });

    // calculate query hash
    // add support multiple fields in query property

    verifier.fullVerify(tokenString, authRequest);
  });
});
